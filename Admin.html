<!doctype html>
<html lang="pt-br">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Admin Pedidos (simple)</title>
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:0;background:#0b0c10;color:#e6e7ee}
  header,main{max-width:1000px;margin:auto;padding:16px}
  .card{background:#111216;border:1px solid #25272c;border-radius:12px;padding:14px;margin:12px 0}
  input,button{background:#161820;color:#e6e7ee;border:1px solid #25272c;border-radius:8px;padding:10px}
  button{cursor:pointer}
  .row{border-bottom:1px solid #25272c;padding:10px 0}
  .muted{color:#9aa0a6}
  .flex{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .hidden{display:none}
</style>
</head>
<body>
<header>
  <h2>ðŸ“Ÿ Admin â€” Pedidos</h2>
</header>
<main>
  <div id="loginBox" class="card">
    <div class="flex">
      <input id="user" placeholder="usuÃ¡rio" />
      <input id="pass" placeholder="senha" type="password" />
      <button id="btnLogin">Entrar</button>
    </div>
    <p class="muted">UsuÃ¡rio: <code>montanhesa</code> â€¢ Senha: <code>12montanhesa21</code></p>
  </div>

  <div id="panel" class="card hidden">
    <div class="flex">
      <button id="btnRefresh">Atualizar agora</button>
      <button id="btnConnectFile">Conectar arquivo do dia</button>
      <label class="flex"><input type="checkbox" id="autoRefresh"> Atualizar a cada 5s</label>
      <span id="fileStatus" class="muted">Sem arquivo</span>
    </div>
    <p class="muted">Pedidos lidos da planilha e gravados em um <strong>.txt</strong> local quando conectado.</p>
    <div id="list" class="card"></div>
  </div>
</main>

<script>
const GAS_URL = "https://script.google.com/macros/s/AKfycbzrrsvUfTaYUXVVFH6lTcGCUpSPkP57IL_lBNcxIgAz1hyevQJqHTMViOPG1Tj4jT4QXw/exec";
const USER_OK = "montanhesa";
const PASS_OK = "12montanhesa21";

const loginBox = document.getElementById("loginBox");
const panel    = document.getElementById("panel");
document.getElementById("btnLogin").onclick = ()=>{
  const u = document.getElementById("user").value.trim();
  const p = document.getElementById("pass").value;
  if (u === USER_OK && p === PASS_OK) {
    loginBox.classList.add("hidden");
    panel.classList.remove("hidden");
  } else {
    alert("Login invÃ¡lido.");
  }
};

// ====== Ler pedidos da planilha ======
async function fetchOrders(){
  try{
    // cache-buster pra nÃ£o ficar preso em cache do navegador/proxy
    const res = await fetch(GAS_URL + "?t=" + Date.now());
    const j = await res.json();
    if(!j.ok) throw new Error("Formato invÃ¡lido");
    return j.rows || [];
  }catch(e){
    alert("Falha ao buscar pedidos: " + e.message);
    return [];
  }
}

// ====== Exibir e gravar no TXT ======
const listEl = document.getElementById("list");
let fileHandle = null;
let lastDumpCount = 0;

document.getElementById("btnRefresh").onclick = refresh;

document.getElementById("btnConnectFile").onclick = async ()=>{
  try{
    const today = new Date().toISOString().slice(0,10);
    fileHandle = await window.showSaveFilePicker({
      suggestedName: `Pedidos-${today}.txt`,
      types: [{ description: "Texto", accept: {"text/plain": [".txt"]} }]
    });
    document.getElementById("fileStatus").textContent = "Arquivo conectado âœ…";
    lastDumpCount = 0; // recomeÃ§a contagem
    await refresh();
  }catch(e){
    alert("NÃ£o foi possÃ­vel conectar arquivo: " + e.message);
  }
};

async function refresh(){
  const orders = await fetchOrders();
  renderList(orders);

  if(fileHandle){
    const lines = orders.map(o => {
      const ts = formatDate(o.timestamp);
      const itens = Array.isArray(o.items)
        ? o.items.map(i => ` - ${i.nome} x${i.qtd} â€” R$ ${(i.preco*i.qtd).toFixed(2).replace('.',',')}`).join("\n")
        : o.items;
      return `[${ts}] #${o.orderId} | Cmd ${o.cmd} | ${o.name}\n${itens}\nTotal: R$ ${(o.total||0).toFixed(2).replace('.',',')}\n${o.delivery}\n\n`;
    });

    if(orders.length > lastDumpCount){
      const delta = lines.slice(lastDumpCount).join("");
      await appendToFile(delta);
      lastDumpCount = orders.length;
      document.getElementById("fileStatus").textContent = "Gravado no arquivo âœ…";
    }
  }
}

function renderList(orders){
  if(orders.length === 0){
    listEl.innerHTML = '<p class="muted">Sem pedidos.</p>';
    return;
  }
  listEl.innerHTML = orders.map(o=>{
    const ts = formatDate(o.timestamp);
    const itens = Array.isArray(o.items)
      ? o.items.map(i => `<div>â€¢ <strong>${i.nome}</strong> x${i.qtd} â€” R$ ${(i.preco*i.qtd).toFixed(2).replace('.',',')}</div>`).join("")
      : o.items;
    return `
      <div class="row">
        <div><strong>#${o.orderId}</strong> <span class="muted">(${ts})</span></div>
        <div>Comanda <strong>${o.cmd}</strong> â€” <strong>${o.name||'â€”'}</strong></div>
        <div style="margin-top:6px">${itens}</div>
        <div style="margin-top:6px"><strong>Total:</strong> R$ ${(o.total||0).toFixed(2).replace('.',',')} â€” <span class="muted">${o.delivery||''}</span></div>
      </div>`;
  }).join("");
}

function formatDate(ts){
  try{ return (new Date(ts)).toLocaleString("pt-BR"); }
  catch{ return String(ts); }
}

async function appendToFile(text){
  const writable = await fileHandle.createWritable({ keepExistingData: true });
  await writable.write(text);
  await writable.close();
}

// ====== Auto-atualizaÃ§Ã£o (5s) ======
const autoRefresh = document.getElementById('autoRefresh');
let autoTimer = null;

autoRefresh?.addEventListener('change', ()=>{
  if (autoRefresh.checked) {
    refresh(); // atualiza jÃ¡
    autoTimer = setInterval(refresh, 5000); // a cada 5s
  } else {
    clearInterval(autoTimer);
  }
});

// limpa o timer ao fechar a aba
window.addEventListener('beforeunload', ()=> clearInterval(autoTimer));
</script>
</body>
</html>

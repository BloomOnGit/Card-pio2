<!doctype html>
<html lang="pt-br">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Admin Pedidos (filtrado por mesa)</title>
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:0;background:#0b0c10;color:#e6e7ee}
  header,main{max-width:1000px;margin:auto;padding:16px}
  .card{background:#111216;border:1px solid #25272c;border-radius:12px;padding:14px;margin:12px 0}
  input,button{background:#161820;color:#e6e7ee;border:1px solid #25272c;border-radius:8px;padding:10px}
  button{cursor:pointer}
  .row{border-bottom:1px solid #25272c;padding:10px 0}
  .muted{color:#9aa0a6}
  .flex{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .hidden{display:none}
  .sec{background:#1b1f2a;border-color:#25272c}
</style>
</head>
<body>
<header>
  <h2>ðŸ“Ÿ Admin â€” Pedidos</h2>
  <p class="muted" id="mesaInfo"></p>
</header>
<main>
  <!-- LOGIN -->
  <div id="loginBox" class="card">
    <div class="flex">
      <input id="user" placeholder="usuÃ¡rio" />
      <input id="pass" placeholder="senha" type="password" />
      <button id="btnLogin">Entrar</button>
    </div>
    <p class="muted">UsuÃ¡rio: <code>montanhesa</code> â€¢ Senha: <code>12montanhesa21</code></p>
  </div>

  <!-- PAINEL -->
  <div id="panel" class="card hidden">
    <div class="flex">
      <button id="btnRefresh">Atualizar agora</button>
      <button id="btnClearScreen" class="sec">Limpar tela</button>
      <button id="btnLogout" class="sec">Sair</button>
      <span id="uiStatus" class="muted"></span>
    </div>
    <p class="muted">Exibindo apenas pedidos da <strong>mesa selecionada</strong>.</p>
    <div id="list" class="card"></div>
  </div>
</main>

<script>
/* CONFIG */
const GAS_URL = "https://script.google.com/macros/s/AKfycbzrrsvUfTaYUXVVFH6lTcGCUpSPkP57IL_lBNcxIgAz1hyevQJqHTMViOPG1Tj4jT4QXw/exec";
const USER_OK = "montanhesa";
const PASS_OK = "12montanhesa21";
const LOGIN_KEY = "admin_logged";

/* MESA */
const params = new URLSearchParams(location.search);
const MESA = params.get("cmd") || null;
document.getElementById("mesaInfo").textContent = MESA ? `ðŸª‘ Mesa ${MESA}` : "Todas as mesas";

/* ELEMENTOS */
const loginBox = document.getElementById("loginBox");
const panel = document.getElementById("panel");
const listEl = document.getElementById("list");
const uiStatus = document.getElementById("uiStatus");

let hideBeforeTs = 0;
let lastPing = 0;
let pollTimer = null;
let pollIntervalMs = 10000; // verificar a cada 10s por padrÃ£o
let pollBackoff = 1; // multiplicador em caso de erro

/* LOGIN */
document.getElementById("btnLogin").onclick = async ()=>{
  const u = document.getElementById("user").value.trim();
  const p = document.getElementById("pass").value;
  if(u===USER_OK && p===PASS_OK){
    localStorage.setItem(LOGIN_KEY,"true");
    showPanel();
    startPolling();
  } else alert("Login invÃ¡lido.");
};

function showPanel(){
  loginBox.classList.add("hidden");
  panel.classList.remove("hidden");
  refresh();
}

document.getElementById("btnLogout").onclick = ()=>{
  stopPolling();
  localStorage.removeItem(LOGIN_KEY);
  location.reload();
};

if(localStorage.getItem(LOGIN_KEY)==="true"){
  showPanel();
  startPolling();
}

/* FETCH PEDIDOS */
async function fetchOrders(){
  try{
    const res = await fetch(GAS_URL + "?t=" + Date.now(), {cache: "no-store"});
    if(!res.ok) throw new Error("HTTP " + res.status);
    const j = await res.json();
    let rows = j.rows || [];
    if (MESA) rows = rows.filter(o => String(o.cmd) === String(MESA));
    return rows;
  }catch(e){
    console.warn("Erro ao buscar pedidos:", e);
    throw e;
  }
}

/* RENDER */
async function refresh(){
  uiStatus.textContent = "ðŸ”„ Atualizando...";
  try{
    const orders = await fetchOrders();
    const visible = hideBeforeTs ? orders.filter(o => new Date(o.timestamp).getTime() > hideBeforeTs) : orders;
    const sorted = visible.sort((a,b)=> new Date(b.timestamp) - new Date(a.timestamp));
    renderList(sorted);
    uiStatus.textContent = "âœ… Atualizado";
    setTimeout(()=> uiStatus.textContent = "", 2000);
  }catch(e){
    uiStatus.textContent = "âŒ Erro ao atualizar";
    console.warn(e);
    setTimeout(()=> uiStatus.textContent = "", 3000);
  }
}

function renderList(orders){
  if(!orders || orders.length === 0){
    listEl.innerHTML = '<p class="muted">Sem pedidos.</p>';
    return;
  }
  listEl.innerHTML = orders.map(o=>{
    const ts = new Date(o.timestamp).toLocaleString("pt-BR");
    const itens = (o.items||[]).map(i=>`<div>â€¢ <strong>${i.nome}</strong> x${i.qtd} â€” R$ ${(i.preco*i.qtd).toFixed(2).replace('.',',')}</div>`).join("");
    return `<div class="row">
      <div><strong>#${o.orderId||'â€”'}</strong> <span class="muted">(${ts})</span></div>
      <div>Comanda <strong>${o.cmd}</strong></div>
      <div style="margin-top:6px">${itens}</div>
      <div style="margin-top:6px"><strong>Total:</strong> R$ ${(o.total||0).toFixed(2).replace('.',',')}</div>
    </div>`;
  }).join("");
}

/* CONTROLES */
document.getElementById("btnRefresh").onclick = refresh;
document.getElementById("btnClearScreen").onclick = ()=>{
  if(!confirm("Limpar tela?")) return;
  hideBeforeTs = Date.now();
  listEl.innerHTML = '<p class="muted">Tela limpa â€” aguardando novos pedidos.</p>';
};

/* POLLING ROBUSTO */
/*
 - checkForNewOrders() chama ?checkPing=1 para obter lastPing persistente no GAS
 - se > lastPing local => chama refresh() e atualiza lastPing
 - em caso de erro aumenta backoff (atÃ© 6x) para evitar floods
*/
async function checkForNewOrders(){
  try{
    const res = await fetch(GAS_URL + "?checkPing=1&t=" + Date.now(), {cache:"no-store"});
    if(!res.ok) throw new Error("HTTP " + res.status);
    const text = await res.text();
    const newPing = parseInt(text) || 0;
    if(newPing > lastPing){
      lastPing = newPing;
      // atualizaÃ§Ã£o imediata
      await refresh();
    }
    // se tudo ok, reset backoff
    pollBackoff = 1;
  }catch(e){
    console.warn("checkForNewOrders falhou:", e);
    // aumentar temporariamente intervalo (exponential backoff com cap)
    pollBackoff = Math.min(pollBackoff * 2, 6);
  } finally {
    scheduleNextPoll();
  }
}

function scheduleNextPoll(){
  clearInterval(pollTimer);
  const next = pollIntervalMs * pollBackoff;
  pollTimer = setInterval(checkForNewOrders, next);
  // TambÃ©m dispare imediatamente (setInterval aguarda), entÃ£o:
  // mas sÃ³ se jÃ¡ estiver mostrado o painel (evita chamadas antes do login)
}

/* start/stop polling (controlado no login/logout) */
function startPolling(){
  // obter estado inicial do ping para nÃ£o disparar refresh desnecessÃ¡rio
  (async ()=>{
    try{
      const res = await fetch(GAS_URL + "?checkPing=1&t=" + Date.now(), {cache:"no-store"});
      const text = await res.text();
      lastPing = parseInt(text) || 0;
    }catch(e){
      console.warn("Falha ao obter lastPing inicial:", e);
      lastPing = 0;
    } finally {
      pollBackoff = 1;
      // schedule first run quickly
      clearInterval(pollTimer);
      pollTimer = setInterval(checkForNewOrders, pollIntervalMs);
      // fire first check after a short delay to let UI settle
      setTimeout(checkForNewOrders, 1000);
    }
  })();
}

function stopPolling(){
  clearInterval(pollTimer);
  pollTimer = null;
}

/* cleanup on unload */
window.addEventListener('beforeunload', ()=> stopPolling());
</script>
</body>
</html>

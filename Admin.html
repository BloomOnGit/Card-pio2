<!doctype html>
<html lang="pt-br">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Admin Pedidos (filtrado por mesa)</title>
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:0;background:#0b0c10;color:#e6e7ee}
  header,main{max-width:1000px;margin:auto;padding:16px}
  .card{background:#111216;border:1px solid #25272c;border-radius:12px;padding:14px;margin:12px 0}
  input,button{background:#161820;color:#e6e7ee;border:1px solid #25272c;border-radius:8px;padding:10px}
  button{cursor:pointer}
  .row{border-bottom:1px solid #25272c;padding:10px 0}
  .muted{color:#9aa0a6}
  .flex{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .hidden{display:none}
  .sec{background:#1b1f2a;border-color:#25272c}
</style>
</head>
<body>
<header>
  <h2>ðŸ“Ÿ Admin â€” Pedidos</h2>
  <p class="muted" id="mesaInfo"></p>
</header>
<main>
  <div id="loginBox" class="card">
    <div class="flex">
      <input id="user" placeholder="usuÃ¡rio" />
      <input id="pass" placeholder="senha" type="password" />
      <button id="btnLogin">Entrar</button>
    </div>
    <p class="muted">UsuÃ¡rio: <code>montanhesa</code> â€¢ Senha: <code>12montanhesa21</code></p>
  </div>

  <div id="panel" class="card hidden">
    <div class="flex">
      <button id="btnRefresh">Atualizar agora</button>
      <button id="btnConnectFile">Conectar arquivo do dia</button>
      <button id="btnClearScreen" class="sec">Limpar tela</button>
      <span id="fileStatus" class="muted">Sem arquivo</span>
      <span id="uiStatus" class="muted"></span>
    </div>
    <p class="muted">Exibindo apenas pedidos da <strong>mesa selecionada</strong>.</p>
    <div id="list" class="card"></div>
  </div>
</main>

<script>
const GAS_URL = "https://script.google.com/macros/s/AKfycbzrrsvUfTaYUXVVFH6lTcGCUpSPkP57IL_lBNcxIgAz1hyevQJqHTMViOPG1Tj4jT4QXw/exec";
const USER_OK = "montanhesa";
const PASS_OK = "12montanhesa21";
const params = new URLSearchParams(location.search);
const MESA = params.get("cmd") || null;
document.getElementById("mesaInfo").textContent = MESA ? `ðŸª‘ Mesa ${MESA}` : "Todas as mesas (modo geral)";
const channel = new BroadcastChannel("pedidos");

const loginBox = document.getElementById("loginBox");
const panel = document.getElementById("panel");
document.getElementById("btnLogin").onclick = ()=>{
  const u=document.getElementById("user").value.trim();
  const p=document.getElementById("pass").value;
  if(u===USER_OK && p===PASS_OK){ loginBox.classList.add("hidden"); panel.classList.remove("hidden"); refresh(); }
  else alert("Login invÃ¡lido.");
};

async function fetchOrders(){
  const res = await fetch(GAS_URL + "?t=" + Date.now());
  const j = await res.json();
  let rows = j.rows || [];
  if(MESA) rows = rows.filter(o => String(o.cmd)===String(MESA));
  return rows;
}

const listEl = document.getElementById("list");
let fileHandle = null;
let seenIds = new Set();
let hideBeforeTs = 0;

async function refresh(){
  const orders = await fetchOrders();
  const visible = hideBeforeTs ? orders.filter(o => new Date(o.timestamp).getTime()>hideBeforeTs) : orders;
  const sortedDesc = visible.slice().sort((a,b)=> new Date(b.timestamp)-new Date(a.timestamp));
  renderList(sortedDesc);
}

function renderList(orders){
  if(orders.length===0){ listEl.innerHTML='<p class="muted">Sem pedidos.</p>'; return; }
  listEl.innerHTML = orders.map(o=>{
    const ts = new Date(o.timestamp).toLocaleString("pt-BR");
    const itens = (o.items||[]).map(i=>`<div>â€¢ <strong>${i.nome}</strong> x${i.qtd} â€” R$ ${(i.preco*i.qtd).toFixed(2).replace('.',',')}</div>`).join("");
    return `<div class="row">
      <div><strong>#${o.orderId}</strong> <span class="muted">(${ts})</span></div>
      <div>Comanda <strong>${o.cmd}</strong></div>
      <div style="margin-top:6px">${itens}</div>
      <div style="margin-top:6px"><strong>Total:</strong> R$ ${(o.total||0).toFixed(2).replace('.',',')}</div>
    </div>`;
  }).join("");
}

document.getElementById("btnRefresh").onclick = refresh;
document.getElementById("btnClearScreen").onclick = ()=>{
  if(!confirm("Limpar tela?")) return;
  hideBeforeTs = Date.now();
  renderList([]);
};

// ðŸ”” Quando o carrinho enviar um pedido, atualiza automaticamente
channel.onmessage = (ev)=>{
  if(ev.data?.type === "novo-pedido"){
    console.log("Novo pedido recebido, atualizando...");
    refresh();
  }
};
</script>
</body>
</html>

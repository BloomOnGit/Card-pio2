<!doctype html>
<html lang="pt-br">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Admin Pedidos (simple)</title>
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:0;background:#0b0c10;color:#e6e7ee}
  header,main{max-width:1000px;margin:auto;padding:16px}
  .card{background:#111216;border:1px solid #25272c;border-radius:12px;padding:14px;margin:12px 0}
  input,button{background:#161820;color:#e6e7ee;border:1px solid #25272c;border-radius:8px;padding:10px}
  button{cursor:pointer}
  .row{border-bottom:1px solid #25272c;padding:10px 0}
  .muted{color:#9aa0a6}
  .flex{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .hidden{display:none}
  .sec{background:#1b1f2a;border-color:#25272c}
</style>
</head>
<body>
<header>
  <h2>ðŸ“Ÿ Admin â€” Pedidos</h2>
</header>
<main>
  <div id="loginBox" class="card">
    <div class="flex">
      <input id="user" placeholder="usuÃ¡rio" />
      <input id="pass" placeholder="senha" type="password" />
      <button id="btnLogin">Entrar</button>
    </div>
    <p class="muted">UsuÃ¡rio: <code>montanhesa</code> â€¢ Senha: <code>12montanhesa21</code></p>
  </div>

  <div id="panel" class="card hidden">
    <div class="flex">
      <button id="btnRefresh">Atualizar agora</button>
      <button id="btnConnectFile">Conectar arquivo do dia</button>
      <label class="flex"><input type="checkbox" id="autoRefresh"> Atualizar a cada 5s</label>
      <button id="btnClearScreen" class="sec">Limpar tela</button>
      <span id="fileStatus" class="muted">Sem arquivo</span>
      <span id="uiStatus" class="muted"></span>
    </div>
    <p class="muted">Pedidos lidos da planilha e gravados em um <strong>.txt</strong> local quando conectado.</p>
    <div id="list" class="card"></div>
  </div>
</main>

<script>
const GAS_URL = "https://script.google.com/macros/s/AKfycbzrrsvUfTaYUXVVFH6lTcGCUpSPkP57IL_lBNcxIgAz1hyevQJqHTMViOPG1Tj4jT4QXw/exec";
const USER_OK = "montanhesa";
const PASS_OK = "12montanhesa21";

const loginBox = document.getElementById("loginBox");
const panel    = document.getElementById("panel");
document.getElementById("btnLogin").onclick = ()=>{
  const u = document.getElementById("user").value.trim();
  const p = document.getElementById("pass").value;
  if (u === USER_OK && p === PASS_OK) {
    loginBox.classList.add("hidden");
    panel.classList.remove("hidden");
  } else {
    alert("Login invÃ¡lido.");
  }
};

// ====== Ler pedidos da planilha ======
async function fetchOrders(){
  try{
    const res = await fetch(GAS_URL + "?t=" + Date.now()); // cache-buster
    const j = await res.json();
    if(!j.ok) throw new Error("Formato invÃ¡lido");
    return j.rows || [];
  }catch(e){
    alert("Falha ao buscar pedidos: " + e.message);
    return [];
  }
}

// ====== Exibir (novos no topo) e gravar no TXT sÃ³ pedidos novos ======
const listEl = document.getElementById("list");
const fileStatus = document.getElementById("fileStatus");
const uiStatus = document.getElementById("uiStatus");
let fileHandle = null;
let seenIds = new Set();     // evita duplicar no arquivo
let hideBeforeTs = 0;        // tudo com timestamp <= isso fica oculto (limpar tela)

document.getElementById("btnRefresh").onclick = refresh;

document.getElementById("btnConnectFile").onclick = async ()=>{
  try{
    const today = new Date().toISOString().slice(0,10);
    fileHandle = await window.showSaveFilePicker({
      suggestedName: `Pedidos-${today}.txt`,
      types: [{ description: "Texto", accept: {"text/plain": [".txt"]} }]
    });
    fileStatus.textContent = "Arquivo conectado âœ…";
    seenIds = new Set(); // grava todos os atuais uma vez
    await refresh();
  }catch(e){
    alert("NÃ£o foi possÃ­vel conectar arquivo: " + e.message);
  }
};

// BotÃ£o: Limpar tela (nÃ£o apaga histÃ³rico nem TXT)
document.getElementById("btnClearScreen").onclick = ()=>{
  if(!confirm("Tem certeza que deseja limpar a tela? (isso NÃƒO apaga a planilha nem o arquivo .txt)")) return;
  hideBeforeTs = Date.now();         // a partir de agora sÃ³ mostra novos
  uiStatus.textContent = "Tela limpa â€” mostrando apenas pedidos novos.";
  renderList([]);                    // esvazia a tela imediatamente
};

function tsValue(x){
  const d = new Date(x);
  return isNaN(d.getTime()) ? 0 : d.getTime();
}

async function refresh(){
  const orders = await fetchOrders();

  // 1) Filtra pedidos antigos se a tela foi limpa
  const visible = hideBeforeTs
    ? orders.filter(o => tsValue(o.timestamp) > hideBeforeTs)
    : orders;

  // 2) ExibiÃ§Ã£o: novos no topo (desc)
  const sortedDesc = visible.slice().sort((a,b)=> tsValue(b.timestamp) - tsValue(a.timestamp));
  renderList(sortedDesc);

  // 3) Se conectado ao arquivo, grava apenas pedidos ainda nÃ£o vistos (ordem asc)
  if(fileHandle){
    const newOnes = orders
      .filter(o => o.orderId && !seenIds.has(o.orderId))
      .sort((a,b)=> tsValue(a.timestamp) - tsValue(b.timestamp));

    if(newOnes.length){
      const delta = newOnes.map(formatLine).join("");
      await appendToFile(delta);
      newOnes.forEach(o => seenIds.add(o.orderId));
      fileStatus.textContent = `Gravado no arquivo âœ… (+${newOnes.length})`;
    }
  }
}

function renderList(orders){
  if(orders.length === 0){
    listEl.innerHTML = '<p class="muted">Sem pedidos.</p>';
    return;
  }
  listEl.innerHTML = orders.map(o=>{
    const ts = formatDate(o.timestamp);
    const itens = Array.isArray(o.items)
      ? o.items.map(i => `<div>â€¢ <strong>${i.nome}</strong> x${i.qtd} â€” R$ ${(i.preco*i.qtd).toFixed(2).replace('.',',')}</div>`).join("")
      : (o.items || "");
    return `
      <div class="row">
        <div><strong>#${o.orderId || 'â€”'}</strong> <span class="muted">(${ts})</span></div>
        <div>Comanda <strong>${o.cmd}</strong> â€” <strong>${o.name||'â€”'}</strong></div>
        <div style="margin-top:6px">${itens}</div>
        <div style="margin-top:6px"><strong>Total:</strong> R$ ${(o.total||0).toFixed(2).replace('.',',')} â€” <span class="muted">${o.delivery||''}</span></div>
      </div>`;
  }).join("");
}

function formatLine(o){
  const ts = formatDate(o.timestamp);
  const itens = Array.isArray(o.items)
    ? o.items.map(i => ` - ${i.nome} x${i.qtd} â€” R$ ${(i.preco*i.qtd).toFixed(2).replace('.',',')}`).join("\n")
    : (o.items || "");
  return `[${ts}] #${o.orderId || 'â€”'} | Cmd ${o.cmd} | ${o.name || 'â€”'}\n${itens}\nTotal: R$ ${(o.total||0).toFixed(2).replace('.',',')}\n${o.delivery||''}\n\n`;
}

function formatDate(ts){
  try{ return (new Date(ts)).toLocaleString("pt-BR"); }
  catch{ return String(ts); }
}

async function appendToFile(text){
  const writable = await fileHandle.createWritable({ keepExistingData: true });
  await writable.write(text);
  await writable.close();
}

// ====== Auto-atualizaÃ§Ã£o (5s) ======
const autoRefresh = document.getElementById('autoRefresh');
let autoTimer = null;

autoRefresh?.addEventListener('change', ()=>{
  if (autoRefresh.checked) {
    refresh(); // atualiza jÃ¡
    autoTimer = setInterval(refresh, 5000); // a cada 5s
  } else {
    clearInterval(autoTimer);
  }
});
window.addEventListener('beforeunload', ()=> clearInterval(autoTimer));
</script>
</body>
</html>

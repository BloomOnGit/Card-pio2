<!doctype html>
<html lang="pt-br">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Carrinho</title>
<style>
  :root{--bg:#fafafa;--ink:#111;--muted:#666;--line:#e6e6e6;--acc:#111;}
  *{box-sizing:border-box}
  body{margin:0;background:#fafafa;color:#111;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
  header{position:sticky;top:0;background:#fff;border-bottom:1px solid #e6e6e6;padding:12px 16px;display:flex;align-items:center;justify-content:space-between;z-index:10}
  a{text-decoration:none;color:inherit}
  .meta{font-size:.9rem;color:#666}
  main{max-width:900px;margin:0 auto;padding:16px}
  .row{display:grid;grid-template-columns:1fr auto auto;gap:8px 12px;align-items:center;padding:12px 0;border-bottom:1px solid #e6e6e6;background:#fff}
  .muted{color:#666}
  .chip{border:1px solid #e6e6e6;border-radius:999px;padding:4px 8px;background:#fff;cursor:pointer}
  .qty{display:inline-flex;gap:8px;align-items:center}
  .totals{display:flex;justify-content:space-between;align-items:center;padding:16px 0}
  .btn{display:inline-block;padding:12px 16px;border-radius:10px;border:none;background:#111;color:#fff;font-weight:700;text-align:center;cursor:pointer}
  .btn.sec{background:#fff;color:#111;border:1px solid #e6e6e6}
  .btn[disabled]{opacity:.6;cursor:not-allowed}
  .card{background:#fff;border:1px solid #e6e6e6;border-radius:12px;padding:12px;margin:14px 0}
  .hide{display:none}
  .overlay{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;padding:16px;z-index:50}
  .modal{width:100%;max-width:420px;background:#fff;border:1px solid #e6e6e6;border-radius:16px;padding:16px}
  input[type="text"]{width:100%;padding:10px;border:1px solid #e6e6e6;border-radius:8px}
  label{display:flex;gap:8px;align-items:center;cursor:pointer}
</style>
</head>
<body>
  <header>
    <a id="backLink" href="#">‚Üê Voltar</a>
    <div class="meta" id="metaInfo">Comanda ‚Äî | Nome ‚Äî</div>
  </header>

  <main>
    <h1 style="margin:8px 0 12px">Seu carrinho</h1>
    <div id="cartList" class="card"></div>

    <div class="totals">
      <div class="muted">Itens: <span id="count">0</span></div>
      <div><strong>Total: R$ <span id="total">0,00</span></strong></div>
    </div>

    <div style="display:flex;gap:8px;flex-wrap:wrap">
      <button class="btn sec" id="clearCart">Limpar carrinho</button>
      <button class="btn" id="sendOrder">Enviar pedido</button>
    </div>
  </main>

  <!-- Modal: Como deseja receber -->
  <div class="overlay" id="recvOverlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="recvTitle">
      <h3 id="recvTitle" style="margin:0 0 8px">Como deseja receber?</h3>
      <div style="display:flex;flex-direction:column;gap:8px;margin-bottom:10px">
        <label><input type="radio" name="recv" value="mesa" checked> Entrega na mesa</label>
        <div id="mesaBox"><input id="mesaInput" type="text" inputmode="numeric" placeholder="N√∫mero da mesa" /></div>
        <label><input type="radio" name="recv" value="balcao"> Retirar no balc√£o pelo nome</label>
      </div>
      <div style="display:flex;gap:8px;justify-content:flex-end">
        <button class="btn sec" id="recvCancel" type="button">Cancelar</button>
        <button class="btn" id="recvConfirm" type="button">Confirmar</button>
      </div>
    </div>
  </div>

<script>
/* ------- CONFIG: sua URL do Apps Script (termina com /exec) ------- */
const GAS_URL = "https://script.google.com/macros/s/AKfycbzrrsvUfTaYUXVVFH6lTcGCUpSPkP57IL_lBNcxIgAz1hyevQJqHTMViOPG1Tj4jT4QXw/exec";

/* ------- PARAMS & STORAGE (ISOLADO POR COMANDA) ------- */
const params = new URLSearchParams(location.search);
const CMD = params.get("cmd") || "default";
const storeCartKey = (cmd)=> `cart_for_cmd_${cmd}`;
const storeNameKey = (cmd)=> `name_for_cmd_${cmd}`;

let cart = loadCart();
let nomeCliente = localStorage.getItem(storeNameKey(CMD)) || "‚Äî";

function loadCart(){ try { return JSON.parse(localStorage.getItem(storeCartKey(CMD))) || []; } catch { return []; } }
function saveCart(){ localStorage.setItem(storeCartKey(CMD), JSON.stringify(cart)); }
function money(n){ return n.toLocaleString("pt-BR",{minimumFractionDigits:2, maximumFractionDigits:2}); }

/* ------- CARRINHO ------- */
function removeOne(id){
  const idx = cart.findIndex(x=>x.id===id);
  if(idx>=0){
    cart[idx].qtd -= 1;
    if(cart[idx].qtd<=0) cart.splice(idx,1);
    saveCart(); render();
  }
}
function addOne(id){
  const item = cart.find(x=>x.id===id);
  if(item){ item.qtd += 1; saveCart(); render(); }
}
function removeAll(id){
  cart = cart.filter(x=>x.id!==id);
  saveCart(); render();
}
function clearCart(){
  cart = []; saveCart(); render();
}
function totalCart(){ return cart.reduce((s,i)=> s + i.preco*i.qtd, 0); }
function countCart(){ return cart.reduce((s,i)=> s + i.qtd, 0); }

/* ------- RENDER ------- */
function render(){
  document.getElementById("backLink").href = `index.html?cmd=${encodeURIComponent(CMD)}`;
  document.getElementById("metaInfo").textContent = `Comanda ${CMD} | Nome ${nomeCliente}`;

  const list = document.getElementById("cartList");
  list.innerHTML = "";

  if(cart.length===0){
    list.innerHTML = '<p class="muted">Seu carrinho est√° vazio.</p>';
  } else {
    cart.forEach(i=>{
      const row = document.createElement('div');
      row.className = "row";

      const name = document.createElement('div');
      name.innerHTML = `<strong>${i.nome}</strong><br><span class="muted">R$ ${money(i.preco)}</span>`;

      const qty = document.createElement('div');
      qty.className = "qty";
      const btnMenos = document.createElement('button'); btnMenos.className="chip"; btnMenos.textContent="‚Äì";
      const spanQtd  = document.createElement('span');  spanQtd.textContent = i.qtd;
      const btnMais  = document.createElement('button'); btnMais.className="chip"; btnMais.textContent="+";
      btnMenos.onclick = ()=> removeOne(i.id);
      btnMais.onclick  = ()=> addOne(i.id);
      qty.append(btnMenos, spanQtd, btnMais);

      const del = document.createElement('button');
      del.className="chip"; del.textContent="Remover";
      del.onclick = ()=> removeAll(i.id);

      row.append(name, qty, del);
      list.append(row);
    });
  }

  document.getElementById("total").textContent = money(totalCart());
  document.getElementById("count").textContent = countCart();
}

/* ------- MODAL DE RECEBIMENTO ------- */
const overlay = document.getElementById('recvOverlay');
const mesaInput = document.getElementById('mesaInput');
const recvRadios = document.getElementsByName('recv');
const btnConfirm = document.getElementById('recvConfirm');
const btnCancel  = document.getElementById('recvCancel');

document.getElementById("sendOrder").onclick = ()=>{
  if(cart.length===0){ alert("Seu carrinho est√° vazio."); return; }
  overlay.style.display = "flex"; overlay.setAttribute('aria-hidden','false');
  mesaInput.focus();
};
btnCancel.onclick = ()=>{
  overlay.style.display = "none"; overlay.setAttribute('aria-hidden','true');
};

/* ------- EVITAR CLIQUE DUPLO + ENVIAR ------- */
let isSending = false;

function genOrderId(cmd){
  const s = Date.now().toString(36).slice(-6).toUpperCase();
  const c = (cmd || "X").toString().padStart(2,"0");
  return `${c}-${s}`;
}

btnConfirm.onclick = async ()=>{
  if (isSending) return; // j√° est√° enviando, ignora
  const recv = [...recvRadios].find(r=>r.checked)?.value || "mesa";

  // valida√ß√£o antes de travar
  let receber = "";
  if(recv === "mesa"){
    const mesa = mesaInput.value.trim();
    if(!mesa){ mesaInput.focus(); return; }
    receber = `Entrega na mesa: ${mesa}`;
  } else {
    receber = `Retirar no balc√£o pelo nome: ${nomeCliente}`;
  }

  // trava o bot√£o at√© terminar
  isSending = true;
  btnConfirm.disabled = true;
  btnCancel.disabled = true;
  const prevLabel = btnConfirm.textContent;
  btnConfirm.textContent = "Enviando...";

  const orderId = genOrderId(CMD);
  const linhas = cart.map(i=>`‚Ä¢ ${i.nome} x${i.qtd} ‚Äî R$ ${money(i.preco*i.qtd)}`).join('\n');
  const msg =
`üßæ Pedido #${orderId}
Comanda: ${CMD}
Nome: ${nomeCliente}

${linhas}

Total: R$ ${money(totalCart())}
${receber}`;

  // 1) Envia para Apps Script (grava na planilha)
  const payload = {
    orderId,
    cmd: CMD,
    name: nomeCliente,
    items: cart.map(i => ({ id:i.id, nome:i.nome, qtd:i.qtd, preco:i.preco })),
    total: totalCart(),
    delivery: receber
  };
  try {
    await fetch(GAS_URL, { method: "POST", body: JSON.stringify(payload) });
  } catch (e) {
    console.warn("Falha ao enviar para planilha:", e);
    // segue mesmo assim para evitar reenvio duplicado
  }

  // 2) (Opcional) tenta copiar para facilitar; n√£o mostra mensagem de copiado
  try { await navigator.clipboard.writeText(msg); } catch {}

  // 3) Limpa carrinho desta comanda
  clearCart();

  // 4) Feedback √∫nico
  alert("Pedido enviado!");

  // 5) Fecha modal e libera para pr√≥ximo pedido
  overlay.style.display = "none"; overlay.setAttribute('aria-hidden','true');
  btnConfirm.textContent = prevLabel;
  btnConfirm.disabled = false;
  btnCancel.disabled = false;
  isSending = false;
};

/* ------- INIT ------- */
document.getElementById("clearCart").onclick = clearCart;
render();
</script>
</body>
</html>

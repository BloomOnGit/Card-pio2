<!doctype html>
<html lang="pt-br">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Carrinho</title>
<style>
  :root {
    --bg:#fafafa;
    --ink:#111;
    --muted:#666;
    --line:#e6e6e6;
  }
  * { box-sizing:border-box; }
  body {
    margin:0;
    background:#fafafa;
    color:#111;
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  }
  header {
    position:sticky;top:0;background:#fff;
    border-bottom:1px solid #e6e6e6;
    padding:12px 16px;
    display:flex;align-items:center;justify-content:space-between;
    z-index:10;
  }
  a { text-decoration:none;color:inherit; }
  .meta { font-size:.9rem;color:#666; }
  main { max-width:900px;margin:0 auto;padding:16px; }
  .row {
    display:grid;
    grid-template-columns:1fr auto auto;
    gap:8px 12px;
    align-items:center;
    padding:12px 0;
    border-bottom:1px solid #e6e6e6;
    background:#fff;
  }
  .muted{color:#666;}
  .chip{
    border:1px solid #e6e6e6;
    border-radius:999px;
    padding:4px 8px;
    background:#fff;
    cursor:pointer;
  }
  .qty{display:inline-flex;gap:8px;align-items:center;}
  .totals{display:flex;justify-content:space-between;align-items:center;padding:16px 0;}
  .btn{
    display:inline-block;
    padding:12px 16px;
    border-radius:10px;
    border:none;
    background:#111;
    color:#fff;
    font-weight:700;
    text-align:center;
    cursor:pointer;
  }
  .btn.sec{background:#fff;color:#111;border:1px solid #e6e6e6;}
  .btn[disabled]{opacity:.6;cursor:not-allowed;}
  .card{background:#fff;border:1px solid #e6e6e6;border-radius:12px;padding:12px;margin:14px 0;}

  /* Tela de carregamento */
  .overlay {
    position:fixed;top:0;left:0;width:100%;height:100%;
    background:rgba(255,255,255,0.85);
    display:flex;align-items:center;justify-content:center;
    z-index:9999;
    flex-direction:column;
  }
  .dots {
    font-size:2rem;
    letter-spacing:4px;
    animation: blink 1s infinite;
  }
  @keyframes blink {
    0%, 20% { opacity:0; }
    50% { opacity:1; }
    100% { opacity:0; }
  }
</style>
</head>
<body>
  <header>
    <a id="backLink" href="#">← Voltar</a>
    <div class="meta" id="metaInfo">Comanda —</div>
  </header>

  <main>
    <h1 style="margin:8px 0 12px">Seu carrinho</h1>
    <div id="cartList" class="card"></div>

    <div class="totals">
      <div class="muted">Itens: <span id="count">0</span></div>
      <div><strong>Total: R$ <span id="total">0,00</span></strong></div>
    </div>

    <div style="display:flex;gap:8px;flex-wrap:wrap">
      <button class="btn sec" id="clearCart">Limpar carrinho</button>
      <button class="btn" id="sendOrder">Enviar pedido</button>
    </div>
  </main>

<script>
/* ------- CONFIG ------- */
const GAS_URL = "https://script.google.com/macros/s/AKfycbzrrsvUfTaYUXVVFH6lTcGCUpSPkP57IL_lBNcxIgAz1hyevQJqHTMViOPG1Tj4jT4QXw/exec";

/* ------- PARAMS & STORAGE ------- */
const params = new URLSearchParams(location.search);
const CMD = params.get("cmd") || "0";
const storeCartKey = (cmd)=> `cart_for_cmd_${cmd}`;
let cart = loadCart();

function loadCart(){ try { return JSON.parse(localStorage.getItem(storeCartKey(CMD))) || []; } catch { return []; } }
function saveCart(){ localStorage.setItem(storeCartKey(CMD), JSON.stringify(cart)); }
function money(n){ return n.toLocaleString("pt-BR",{minimumFractionDigits:2, maximumFractionDigits:2}); }

/* ------- CARRINHO ------- */
function removeOne(id){
  const idx = cart.findIndex(x=>x.id===id);
  if(idx>=0){
    cart[idx].qtd -= 1;
    if(cart[idx].qtd<=0) cart.splice(idx,1);
    saveCart(); render();
  }
}
function addOne(id){
  const item = cart.find(x=>x.id===id);
  if(item){ item.qtd += 1; saveCart(); render(); }
}
function removeAll(id){
  cart = cart.filter(x=>x.id!==id);
  saveCart(); render();
}
function clearCart(){
  cart = []; saveCart(); render();
}
function totalCart(){ return cart.reduce((s,i)=> s + i.preco*i.qtd, 0); }
function countCart(){ return cart.reduce((s,i)=> s + i.qtd, 0); }

/* ------- RENDER ------- */
function render(){
  document.getElementById("backLink").href = `index.html?cmd=${encodeURIComponent(CMD)}`;
  document.getElementById("metaInfo").textContent = `Comanda ${CMD}`;

  const list = document.getElementById("cartList");
  list.innerHTML = "";

  if(cart.length===0){
    list.innerHTML = '<p class="muted">Seu carrinho está vazio.</p>';
  } else {
    cart.forEach(i=>{
      const row = document.createElement('div');
      row.className = "row";

      const name = document.createElement('div');
      name.innerHTML = `<strong>${i.nome}</strong><br><span class="muted">R$ ${money(i.preco)}</span>`;

      const qty = document.createElement('div');
      qty.className = "qty";
      const btnMenos = document.createElement('button'); btnMenos.className="chip"; btnMenos.textContent="–";
      const spanQtd  = document.createElement('span');  spanQtd.textContent = i.qtd;
      const btnMais  = document.createElement('button'); btnMais.className="chip"; btnMais.textContent="+";
      btnMenos.onclick = ()=> removeOne(i.id);
      btnMais.onclick  = ()=> addOne(i.id);
      qty.append(btnMenos, spanQtd, btnMais);

      const del = document.createElement('button');
      del.className="chip"; del.textContent="Remover";
      del.onclick = ()=> removeAll(i.id);

      row.append(name, qty, del);
      list.append(row);
    });
  }

  document.getElementById("total").textContent = money(totalCart());
  document.getElementById("count").textContent = countCart();
}

/* ------- LOADING SCREEN ------- */
function showLoadingScreen() {
  const overlay = document.createElement('div');
  overlay.className = 'overlay';
  overlay.innerHTML = `<div class="dots">...</div>`;
  document.body.append(overlay);
  return overlay;
}

/* ------- ENVIAR PEDIDO DIRETO ------- */
let sending = false;
document.getElementById("sendOrder").onclick = async ()=>{
  if(sending) return;
  if(cart.length===0){ alert("Seu carrinho está vazio."); return; }

  sending = true;
  const sendBtn = document.getElementById("sendOrder");
  sendBtn.disabled = true;

  const overlay = showLoadingScreen();

  const orderId = `${CMD.padStart(2,'0')}-${Date.now().toString(36).slice(-6).toUpperCase()}`;
  const payload = {
    orderId,
    cmd: CMD,
    items: cart.map(i => ({ id:i.id, nome:i.nome, qtd:i.qtd, preco:i.preco })),
    total: totalCart(),
  };

  try {
    await fetch(GAS_URL, { method: "POST", body: JSON.stringify(payload) });
    clearCart();
    overlay.remove();
    alert("Pedido enviado com sucesso!");
  } catch (e) {
    overlay.remove();
    alert("Falha ao enviar pedido. Tente novamente.");
    console.warn("Erro:", e);
  } finally {
    sending = false;
    sendBtn.disabled = false;
  }
};

/* ------- INIT ------- */
document.getElementById("clearCart").onclick = clearCart;
render();
</script>
</body>
</html>

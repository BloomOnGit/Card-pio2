<!doctype html>
<html lang="pt-br">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Carrinho</title>
<style>
  :root{--bg:#fafafa;--ink:#111;--muted:#666;--line:#e6e6e6;--acc:#111;}
  *{box-sizing:border-box}
  body{margin:0;background:#fafafa;color:#111;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
  header{position:sticky;top:0;background:#fff;border-bottom:1px solid #e6e6e6;padding:12px 16px;display:flex;align-items:center;justify-content:space-between;z-index:10}
  a{text-decoration:none;color:inherit}
  .meta{font-size:.9rem;color:#666}
  main{max-width:900px;margin:0 auto;padding:16px}
  .row{display:grid;grid-template-columns:1fr auto auto;gap:8px 12px;align-items:center;padding:12px 0;border-bottom:1px solid #e6e6e6;background:#fff}
  .muted{color:#666}
  .chip{border:1px solid #e6e6e6;border-radius:999px;padding:4px 8px;background:#fff;cursor:pointer}
  .qty{display:inline-flex;gap:8px;align-items:center}
  .totals{display:flex;justify-content:space-between;align-items:center;padding:16px 0}
  .btn{display:inline-block;padding:12px 16px;border-radius:10px;border:none;background:#111;color:#fff;font-weight:700;text-align:center;cursor:pointer}
  .btn.sec{background:#fff;color:#111;border:1px solid #e6e6e6}
  .btn[disabled]{opacity:.6;cursor:not-allowed}
  .card{background:#fff;border:1px solid #e6e6e6;border-radius:12px;padding:12px;margin:14px 0}
</style>
</head>
<body>
  <header>
    <a id="backLink" href="#">‚Üê Voltar</a>
    <div class="meta" id="metaInfo">Comanda ‚Äî</div>
  </header>

  <main>
    <h1 style="margin:8px 0 12px">Seu carrinho</h1>
    <div id="cartList" class="card"></div>

    <div class="totals">
      <div class="muted">Itens: <span id="count">0</span></div>
      <div><strong>Total: R$ <span id="total">0,00</span></strong></div>
    </div>

    <div style="display:flex;gap:8px;flex-wrap:wrap">
      <button class="btn sec" id="clearCart">Limpar carrinho</button>
      <button class="btn" id="sendOrder">Enviar pedido</button>
    </div>
  </main>

<script>
/* ------- CONFIG: sua URL do Apps Script (termina com /exec) ------- */
const GAS_URL = "https://script.google.com/macros/s/AKfycbzrrsvUfTaYUXVVFH6lTcGCUpSPkP57IL_lBNcxIgAz1hyevQJqHTMViOPG1Tj4jT4QXw/exec";

/* ------- PARAMS & STORAGE ------- */
const params = new URLSearchParams(location.search);
const CMD = params.get("cmd") || "0";
const storeCartKey = (cmd)=> `cart_for_cmd_${cmd}`;

let cart = loadCart();

function loadCart(){ try { return JSON.parse(localStorage.getItem(storeCartKey(CMD))) || []; } catch { return []; } }
function saveCart(){ localStorage.setItem(storeCartKey(CMD), JSON.stringify(cart)); }
function money(n){ return n.toLocaleString("pt-BR",{minimumFractionDigits:2, maximumFractionDigits:2}); }

/* ------- CARRINHO ------- */
function removeOne(id){
  const idx = cart.findIndex(x=>x.id===id);
  if(idx>=0){
    cart[idx].qtd -= 1;
    if(cart[idx].qtd<=0) cart.splice(idx,1);
    saveCart(); render();
  }
}
function addOne(id){
  const item = cart.find(x=>x.id===id);
  if(item){ item.qtd += 1; saveCart(); render(); }
}
function removeAll(id){
  cart = cart.filter(x=>x.id!==id);
  saveCart(); render();
}
function clearCart(){
  cart = []; saveCart(); render();
}
function totalCart(){ return cart.reduce((s,i)=> s + i.preco*i.qtd, 0); }
function countCart(){ return cart.reduce((s,i)=> s + i.qtd, 0); }

/* ------- RENDER ------- */
function render(){
  document.getElementById("backLink").href = `index.html?cmd=${encodeURIComponent(CMD)}`;
  document.getElementById("metaInfo").textContent = `Comanda ${CMD}`;

  const list = document.getElementById("cartList");
  list.innerHTML = "";

  if(cart.length===0){
    list.innerHTML = '<p class="muted">Seu carrinho est√° vazio.</p>';
  } else {
    cart.forEach(i=>{
      const row = document.createElement('div');
      row.className = "row";

      const name = document.createElement('div');
      name.innerHTML = `<strong>${i.nome}</strong><br><span class="muted">R$ ${money(i.preco)}</span>`;

      const qty = document.createElement('div');
      qty.className = "qty";
      const btnMenos = document.createElement('button'); btnMenos.className="chip"; btnMenos.textContent="‚Äì";
      const spanQtd  = document.createElement('span');  spanQtd.textContent = i.qtd;
      const btnMais  = document.createElement('button'); btnMais.className="chip"; btnMais.textContent="+";
      btnMenos.onclick = ()=> removeOne(i.id);
      btnMais.onclick  = ()=> addOne(i.id);
      qty.append(btnMenos, spanQtd, btnMais);

      const del = document.createElement('button');
      del.className="chip"; del.textContent="Remover";
      del.onclick = ()=> removeAll(i.id);

      row.append(name, qty, del);
      list.append(row);
    });
  }

  document.getElementById("total").textContent = money(totalCart());
  document.getElementById("count").textContent = countCart();
}

/* ------- ENVIAR PEDIDO DIRETO ------- */
document.getElementById("sendOrder").onclick = async ()=>{
  if(cart.length===0){ alert("Seu carrinho est√° vazio."); return; }

  const orderId = `${CMD.padStart(2,'0')}-${Date.now().toString(36).slice(-6).toUpperCase()}`;
  const linhas = cart.map(i=>`‚Ä¢ ${i.nome} x${i.qtd} ‚Äî R$ ${money(i.preco*i.qtd)}`).join('\n');
  const msg =
`üßæ Pedido #${orderId}
Comanda: ${CMD}

${linhas}

Total: R$ ${money(totalCart())}`;

  // Envia para Google Apps Script
  const payload = {
    orderId,
    cmd: CMD,
    items: cart.map(i => ({ id:i.id, nome:i.nome, qtd:i.qtd, preco:i.preco })),
    total: totalCart(),
  };

  try {
    await fetch(GAS_URL, { method: "POST", body: JSON.stringify(payload) });
  } catch (e) {
    console.warn("Falha ao enviar para planilha:", e);
  }

  // Limpa e feedback
  clearCart();
  alert("Pedido enviado!");
};

/* ------- INIT ------- */
document.getElementById("clearCart").onclick = clearCart;
render();
</script>
</body>
</html>
